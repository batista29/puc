CREATE TABLE ESPECIALIDADE(
CODIGO INTEGER PRIMARY KEY,
NOME VARCHAR2(30) NOT NULL
);
CREATE TABLE MEDICO(
CRM INTEGER PRIMARY KEY,
SALARIO NUMBER(10,2)  NOT NULL,
NOME VARCHAR2(40) NOT NULL,
NOMEESPECIALIDADE INTEGER NOT NULL,
FOREIGN KEY(NOMEESPECIALIDADE) REFERENCES ESPECIALIDADE(CODIGO)
);

CREATE TABLE QUARTO(
NUMEROQUARTO NUMBER PRIMARY KEY,
ANDAR NUMBER
);

CREATE TABLE PACIENTE(
CODIGOPACIENTE INTEGER PRIMARY KEY,
CPF VARCHAR2(12) NOT NULL,
NOME VARCHAR2(30) NOT NULL,
ENDEREÇO VARCHAR2(30) NOT NULL,
RG VARCHAR2(10) NOT NULL,
DATANASCIMENTO DATE NOT NULL,
NUMQUARTO INTEGER NOT NULL,
CRMMEDICO INTEGER NOT NULL ,
HORARIOATENDIMENTO DATE NOT NULL, 
FOREIGN KEY (NUMQUARTO) REFERENCES QUARTO(NUMEROQUARTO),
FOREIGN KEY (CRMMEDICO) REFERENCES MEDICO(CRM)
);

CREATE TABLE TELEFONE_PACIENTE(
CODIGOPACIENTE INTEGER NOT NULL,
TELEFONE VARCHAR2(15) NOT NULL,
FOREIGN KEY (CODIGOPACIENTE) REFERENCES PACIENTE(CODIGOPACIENTE),
PRIMARY KEY (CODIGOPACIENTE, TELEFONE)
);

CREATE TABLE TEMESPECIALIDADE(
CRM INTEGER NOT NULL,
CODIGOESP INTEGER NOT NULL,
FOREIGN KEY (CODIGOESP) REFERENCES ESPECIALIDADE(CODIGO),
FOREIGN KEY (CRM) REFERENCES MEDICO(CRM),
PRIMARY KEY(CRM, CODIGOESP)
);

CREATE TABLE TRATAPLANTONISTA(
CRM INTEGER NOT NULL,
CODIGOPACIENTE INTEGER NOT NULL,
FOREIGN KEY (CRM) REFERENCES MEDICO(CRM),
FOREIGN KEY (CODIGOPACIENTE) REFERENCES PACIENTE(CODIGOPACIENTE),
PRIMARY KEY(CRM,CODIGOPACIENTE)
);
INSERT INTO ESPECIALIDADE VALUES (1, 'Cardiologia');
INSERT INTO ESPECIALIDADE VALUES (2, 'Pediatria');
INSERT INTO ESPECIALIDADE VALUES (3, 'Dermatologia');

INSERT INTO MEDICO VALUES (12345, 15000.00, 'Dr. João Silva', 1);
INSERT INTO MEDICO VALUES (12346, 12000.00, 'Dra. Maria Oliveira', 2);
INSERT INTO MEDICO VALUES (12347, 14000.00, 'Dr. Pedro Santos', 3);

INSERT INTO QUARTO VALUES (101, 1);
INSERT INTO QUARTO VALUES (102, 1);
INSERT INTO QUARTO VALUES (201, 2);

INSERT INTO PACIENTE VALUES (1, '12345678901', 'Ana Paula', 'Rua A, 123', 'MG1234567', DATE '1990-05-15', 101, 12345, TIMESTAMP '2024-11-04 14:30:00');
INSERT INTO PACIENTE VALUES (2, '10987654321', 'Carlos Alberto', 'Rua B, 456', 'SP7654321', DATE '1985-08-20', 102, 12346, TIMESTAMP '2024-11-04 15:00:00');

INSERT INTO TELEFONE_PACIENTE VALUES (1, '1234-5678');
INSERT INTO TELEFONE_PACIENTE VALUES (1, '9876-5432');
INSERT INTO TELEFONE_PACIENTE VALUES (2, '2345-6789');

INSERT INTO TEMESPECIALIDADE VALUES (12345, 1);
INSERT INTO TEMESPECIALIDADE VALUES (12346, 2);
INSERT INTO TEMESPECIALIDADE VALUES (12347, 3);

INSERT INTO TRATAPLANTONISTA VALUES (12345, 1);
INSERT INTO TRATAPLANTONISTA VALUES (12346, 2);









CREATE OR REPLACE FUNCTION OBTER_INFO_PACIENTE(COD_PACIENTE IN INTEGER)
RETURN VARCHAR2 IS
    INFO VARCHAR2(500);
BEGIN
    SELECT 'Paciente: ' || P.NOME || ', Médico: ' || M.NOME || ', Especialidade: ' || E.NOME || ', Horário: ' || TO_CHAR(P.HORARIOATENDIMENTO, 'DD-MM-YYYY HH24:MI:SS')
    INTO INFO
    FROM PACIENTE P
    JOIN MEDICO M ON P.CRMMEDICO = M.CRM
    JOIN ESPECIALIDADE E ON M.NOMEESPECIALIDADE = E.CODIGO
    WHERE P.CODIGOPACIENTE = COD_PACIENTE;

    RETURN INFO;
END;
/

CREATE OR REPLACE FUNCTION OBTER_INFO_MEDICO(CRM_MEDICO IN INTEGER)
RETURN VARCHAR2 IS
    INFO VARCHAR2(500);
BEGIN
    SELECT 'Médico: ' || M.NOME || ', Especialidade: ' || E.NOME
    INTO INFO
    FROM MEDICO M
    JOIN ESPECIALIDADE E ON M.NOMEESPECIALIDADE = E.CODIGO
    WHERE M.CRM = CRM_MEDICO;

    RETURN INFO;
END;
/

CREATE OR REPLACE PROCEDURE OBTER_INFO_COMPLETA_PACIENTE(COD_PACIENTE IN INTEGER) IS
    INFO VARCHAR2(1000);
BEGIN
    SELECT 'Paciente: ' || P.NOME || ', Médico: ' || M.NOME || ', Especialidade: ' || E.NOME || 
           ', Horário: ' || TO_CHAR(P.HORARIOATENDIMENTO, 'DD-MM-YYYY HH24:MI:SS') || ', Quarto: ' || Q.NUMEROQUARTO
    INTO INFO
    FROM PACIENTE P
    JOIN MEDICO M ON P.CRMMEDICO = M.CRM
    JOIN ESPECIALIDADE E ON M.NOMEESPECIALIDADE = E.CODIGO
    JOIN QUARTO Q ON P.NUMQUARTO = Q.NUMEROQUARTO
    WHERE P.CODIGOPACIENTE = COD_PACIENTE;

    DBMS_OUTPUT.PUT_LINE(INFO);
END;
/

CREATE OR REPLACE PROCEDURE ATUALIZAR_HORARIO_PACIENTE(COD_PACIENTE IN INTEGER, CRM_MEDICO IN INTEGER, NOVO_HORARIO IN DATE) IS
BEGIN
    UPDATE PACIENTE
    SET HORARIOATENDIMENTO = NOVO_HORARIO
    WHERE CODIGOPACIENTE = COD_PACIENTE AND CRMMEDICO = CRM_MEDICO;

    COMMIT;
END;
/

CREATE TABLE HISTORICO_MEDICOS (
    CRM INTEGER,
    NOME VARCHAR2(40),
    SALARIO NUMBER(10,2),
    ESPECIALIDADE INTEGER,
    DATA_EXCLUSAO DATE
);

CREATE OR REPLACE TRIGGER HISTORICO_DELETE_MEDICO
AFTER DELETE ON MEDICO
FOR EACH ROW
BEGIN
    INSERT INTO HISTORICO_MEDICOS (CRM, NOME, SALARIO, ESPECIALIDADE, DATA_EXCLUSAO)
    VALUES (:OLD.CRM, :OLD.NOME, :OLD.SALARIO, :OLD.NOMEESPECIALIDADE, SYSDATE);
END;
/

CREATE TABLE LOG_QUARTOS (
    COD_PACIENTE INTEGER,
    QUARTO_ANTERIOR NUMBER,
    QUARTO_NOVO NUMBER,
    DATA_ALTERACAO DATE
);

CREATE OR REPLACE TRIGGER LOG_UPDATE_QUARTO
AFTER UPDATE OF NUMQUARTO ON PACIENTE
FOR EACH ROW
BEGIN
    INSERT INTO LOG_QUARTOS (COD_PACIENTE, QUARTO_ANTERIOR, QUARTO_NOVO, DATA_ALTERACAO)
    VALUES (:OLD.CODIGOPACIENTE, :OLD.NUMQUARTO, :NEW.NUMQUARTO, SYSDATE);
END;
/


SELECT OBTER_INFO_PACIENTE(1) AS INFO FROM DUAL;
SELECT OBTER_INFO_MEDICO(12345) AS INFO FROM DUAL;

EXEC OBTER_INFO_COMPLETA_PACIENTE(1);

SELECT * FROM PACIENTE WHERE CODIGOPACIENTE = 1;
SET SERVEROUTPUT ON;
EXEC ATUALIZAR_HORARIO_PACIENTE(1, 12345, TO_DATE('2024-11-10 16:30:00', 'YYYY-MM-DD HH24:MI:SS'));
SELECT * FROM PACIENTE WHERE CODIGOPACIENTE = 1;




DELETE FROM MEDICO WHERE CRM = 12346;
SELECT * FROM HISTORICO_MEDICOS;
SELECT * FROM MEDICO WHERE CRM = 12346;




UPDATE PACIENTE 
SET NUMQUARTO = 101
WHERE CODIGOPACIENTE = 2;

SELECT * FROM LOG_QUARTOS;